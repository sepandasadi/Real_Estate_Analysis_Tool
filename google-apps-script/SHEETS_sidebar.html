<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --accent:#1a73e8;--accent-dark:#155ab6;--bg:#f7f9fc;--card-bg:#fff;--border:#e0e0e0;
      --radius:10px;--shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    body{font-family:"Inter","Segoe UI",Arial,sans-serif;background:var(--bg);padding:14px;margin:0;color:#333}
    h2{margin-top:0;color:var(--accent-dark);font-weight:600;letter-spacing:.3px}
    .section{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px 16px;margin-bottom:14px}
    label{display:block;font-size:13px;font-weight:600;margin-top:8px;margin-bottom:4px}
    input,select{width:100%;padding:7px 9px;border:1px solid #ccc;border-radius:6px;font-size:13px;
      box-sizing:border-box;transition:border .2s}
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(26,115,232,.15)}
    button{width:100%;padding:10px 12px;font-size:14px;background:var(--accent);color:white;
      border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:background .25s ease}
    button:hover{background:var(--accent-dark)}
    .input-group{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    small{color:#777;font-size:11px}
    hr{border:none;border-top:1px solid var(--border);margin:12px 0}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.85);
      display:none;align-items:center;justify-content:center;z-index:9999;font-size:16px;color:#333}
    .mode-section{display:none;margin-top:12px;padding:12px;background:#f0f4ff;border:1px solid #b8d4ff;border-radius:8px}
    .mode-section.active{display:block}
    .mode-label{font-size:12px;font-weight:700;color:#1a73e8;margin-bottom:8px;display:block}
  </style>
</head>
<body>
  <div id="overlay">‚è≥ Running Analysis‚Ä¶ Please wait</div>

  <h2>üè° REI Assistant</h2>

  <!-- Analysis Mode Selector -->
  <div class="section">
    <label>Analysis Mode</label>
    <select id="analysisMode" onchange="updateModeDescription()">
      <option value="BASIC">‚ö° Basic Mode (0-1 API calls)</option>
      <option value="STANDARD" selected>‚≠ê Standard Mode (2-4 API calls)</option>
      <option value="DEEP">üöÄ Deep Mode (8-12 API calls)</option>
    </select>
    <small id="modeDescription" style="display:block;margin-top:6px;line-height:1.4">
      Hybrid approach: Auto-fetch property details and comps. Optional ARV override.
    </small>
  </div>

  <!-- Property -->
  <div class="section">
    <label>Property Address</label>
    <input style="margin:3px" id="address" placeholder="Street address" />
    <div style="margin:3px 0px 3px 3px" class="input-group">
      <input id="city" placeholder="City" />
      <input id="state" placeholder="State" />
    </div>
    <input style="margin:3px" id="zip" placeholder="ZIP Code" />

    <!-- Basic Mode: Property Details -->
    <div id="basicModeFields" class="mode-section">
      <span class="mode-label">‚ö° Basic Mode: Property Details</span>
      <div class="input-group">
        <div><label>Beds</label><input id="beds" type="number" placeholder="3" min="0" step="1" /></div>
        <div><label>Baths</label><input id="baths" type="number" placeholder="2" min="0" step="0.5" /></div>
      </div>
      <div class="input-group">
        <div><label>Sqft</label><input id="sqft" type="number" placeholder="1500" min="0" step="100" /></div>
        <div><label>Year Built</label><input id="yearBuilt" type="number" placeholder="2000" min="1800" max="2025" step="1" /></div>
      </div>
    </div>
  </div>

  <!-- Financing -->
  <div class="section">
    <label>Purchase Price ($)</label>
    <input id="purchasePrice" type="number" placeholder="e.g. 799000" />
    <div class="input-group">
      <div><label>Down Payment (%)</label><input id="downPayment" type="number" placeholder="20" /></div>
      <div><label>Loan Interest Rate (%)</label><input id="loanInterestRate" type="number" placeholder="6.5" /></div>
    </div>
    <div class="input-group">
      <div><label>Loan Term (Years)</label><input id="loanTerm" type="number" placeholder="30" /></div>
      <div><label>Months to Flip</label><input id="monthsToFlip" type="number" placeholder="6" /></div>
    </div>
    <label>Rehab Cost ($)</label>
    <input id="rehabCost" type="number" placeholder="75000" />
    <div class="input-group">
    <div>
      <label>Cash Investment ($)</label>
      <input id="cashInvestment" type="number" placeholder="e.g. 75000" />
    </div>
    <div>
      <label>HELOC / Loan Interest (%)</label>
      <input id="helocInterest" type="number" placeholder="e.g. 7.0" />
    </div>
  </div>

  <!-- Basic Mode: ARV Input -->
  <div id="basicModeARV" class="mode-section">
    <span class="mode-label">‚ö° Basic Mode: ARV (Required)</span>
    <label>After Repair Value ($)</label>
    <input id="arv" type="number" placeholder="e.g. 400000" min="0" step="1000" />
    <small style="display:block;margin-top:4px;">Provide your estimated ARV or add comps below to calculate automatically.</small>
  </div>

  <!-- Standard Mode: Optional ARV Override -->
  <div id="standardModeARV" class="mode-section">
    <span class="mode-label">‚≠ê Standard Mode: ARV Override (Optional)</span>
    <label>After Repair Value ($)</label>
    <input id="arvOverride" type="number" placeholder="Leave blank to auto-calculate" min="0" step="1000" />
    <small style="display:block;margin-top:4px;">Auto-calculated from comps if left blank. Provide value to override.</small>
  </div>
  </div>

  <!-- Main Action -->
  <div class="section" style="text-align:center;">
    <button onclick="runAnalysis()">üöÄ Run Full Analysis</button>
    <small id="analysisNote">This will generate Flip & Rental analyses with comps and scenarios.</small>
  </div>

  <!-- Developer Tools -->
  <div class="section">
    <details>
      <summary style="cursor:pointer;font-weight:600;">üß™ Developer Tools</summary>
      <button style="margin-top:8px" onclick="testAPI('bridge')">Test Bridge API</button>
      <button style="margin-top:8px" onclick="testAPI('openai')">Test OpenAI API</button>
      <button style="margin-top:8px" onclick="testAPI('gemini')">Test Gemini API</button>
    </details>
  </div>

  <script>
    function showOverlay(show){document.getElementById("overlay").style.display=show?"flex":"none"}

    function updateModeDescription() {
      const mode = document.getElementById("analysisMode").value;
      const previousMode = document.getElementById("analysisMode").getAttribute("data-previous-mode") || "STANDARD";

      // Check if trying to switch to DEEP mode
      if (mode === "DEEP" && previousMode !== "DEEP") {
        // Prompt for password
        const password = prompt("üîí Deep Mode is password protected.\n\nEnter password to unlock:");

        if (password) {
          // Validate password via server
          google.script.run
            .withSuccessHandler(function(isValid) {
              if (isValid) {
                // Password correct - allow mode change
                document.getElementById("analysisMode").setAttribute("data-previous-mode", "DEEP");
                applyModeChanges("DEEP");
              } else {
                // Password incorrect - revert to previous mode
                alert("‚ùå Incorrect password. Deep Mode access denied.");
                document.getElementById("analysisMode").value = previousMode;
                applyModeChanges(previousMode);
              }
            })
            .withFailureHandler(function(error) {
              alert("‚ùå Error validating password: " + error);
              document.getElementById("analysisMode").value = previousMode;
              applyModeChanges(previousMode);
            })
            .validateDeepModePassword(password);
        } else {
          // No password entered - revert to previous mode
          document.getElementById("analysisMode").value = previousMode;
          applyModeChanges(previousMode);
        }
      } else {
        // Not switching to DEEP or already in DEEP - apply changes normally
        document.getElementById("analysisMode").setAttribute("data-previous-mode", mode);
        applyModeChanges(mode);
      }
    }

    function applyModeChanges(mode) {
      const desc = document.getElementById("modeDescription");
      const note = document.getElementById("analysisNote");

      const descriptions = {
        BASIC: "Manual input: You provide all property details, ARV, and comparable properties. Minimal API usage.",
        STANDARD: "Hybrid approach: Auto-fetch property details and comps. Optional ARV override.",
        DEEP: "Full automation: All data auto-fetched including property details, comps, and ARV calculation."
      };

      const notes = {
        BASIC: "Note: Basic Mode requires manual input of property details and comps.",
        STANDARD: "This will generate Flip & Rental analyses with comps and scenarios.",
        DEEP: "This will generate comprehensive analyses with full automation and AI insights."
      };

      desc.textContent = descriptions[mode] || descriptions.STANDARD;
      note.textContent = notes[mode] || notes.STANDARD;

      // Show/hide mode-specific sections
      const basicFields = document.getElementById("basicModeFields");
      const basicARV = document.getElementById("basicModeARV");
      const standardARV = document.getElementById("standardModeARV");

      // Hide all mode sections first
      basicFields.classList.remove("active");
      basicARV.classList.remove("active");
      standardARV.classList.remove("active");

      // Show sections based on selected mode
      if (mode === "BASIC") {
        basicFields.classList.add("active");
        basicARV.classList.add("active");
      } else if (mode === "STANDARD") {
        standardARV.classList.add("active");
      }
      // DEEP mode shows no extra fields (full automation)
    }

    // Initialize mode description on load
    window.onload = function() {
      updateModeDescription();
    };

    function validateInputs() {
      const errors = [];

      // Required fields
      const address = document.getElementById("address").value.trim();
      const city = document.getElementById("city").value.trim();
      const state = document.getElementById("state").value.trim();
      const zip = document.getElementById("zip").value.trim();
      const purchasePrice = +document.getElementById("purchasePrice").value;
      const downPayment = +document.getElementById("downPayment").value;
      const loanInterestRate = +document.getElementById("loanInterestRate").value;
      const loanTerm = +document.getElementById("loanTerm").value;
      const rehabCost = +document.getElementById("rehabCost").value;
      const monthsToFlip = +document.getElementById("monthsToFlip").value;
      const cashInvestment = +document.getElementById("cashInvestment").value;
      const helocInterest = +document.getElementById("helocInterest").value;

      // Validate required fields
      if (!address) errors.push("‚Ä¢ Property address is required");
      if (!city) errors.push("‚Ä¢ City is required");
      if (!state) errors.push("‚Ä¢ State is required");
      if (!zip) errors.push("‚Ä¢ ZIP code is required");

      // Validate numeric fields
      if (!purchasePrice || purchasePrice <= 0) errors.push("‚Ä¢ Purchase price must be greater than 0");
      if (!downPayment || downPayment < 0 || downPayment > 100) errors.push("‚Ä¢ Down payment must be between 0 and 100%");
      if (!loanInterestRate || loanInterestRate < 0 || loanInterestRate > 20) errors.push("‚Ä¢ Loan interest rate must be between 0 and 20%");
      if (!loanTerm || loanTerm <= 0 || loanTerm > 50) errors.push("‚Ä¢ Loan term must be between 1 and 50 years");
      if (rehabCost < 0) errors.push("‚Ä¢ Rehab cost cannot be negative");
      if (!monthsToFlip || monthsToFlip <= 0 || monthsToFlip > 60) errors.push("‚Ä¢ Months to flip must be between 1 and 60");
      if (cashInvestment < 0) errors.push("‚Ä¢ Cash investment cannot be negative");
      if (helocInterest < 0 || helocInterest > 20) errors.push("‚Ä¢ HELOC interest must be between 0 and 20%");

      return errors;
    }

    function runAnalysis(){
      // Validate inputs first
      const errors = validateInputs();
      if (errors.length > 0) {
        alert("Please fix the following errors:\n\n" + errors.join("\n"));
        return;
      }

      const analysisMode = document.getElementById("analysisMode").value;

      const data = {
        address: document.getElementById("address").value.trim(),
        city: document.getElementById("city").value.trim(),
        state: document.getElementById("state").value.trim(),
        zip: document.getElementById("zip").value.trim(),
        purchasePrice: +document.getElementById("purchasePrice").value,
        downPayment: +document.getElementById("downPayment").value,
        cashInvestment: +document.getElementById("cashInvestment").value,
        helocInterest: +document.getElementById("helocInterest").value,
        loanInterestRate: +document.getElementById("loanInterestRate").value,
        loanTerm: +document.getElementById("loanTerm").value,
        rehabCost: +document.getElementById("rehabCost").value,
        monthsToFlip: +document.getElementById("monthsToFlip").value,
        analysisMode: analysisMode
      };

      // Add mode-specific fields
      if (analysisMode === "BASIC") {
        // Basic Mode: Include property details and ARV
        const beds = document.getElementById("beds").value;
        const baths = document.getElementById("baths").value;
        const sqft = document.getElementById("sqft").value;
        const yearBuilt = document.getElementById("yearBuilt").value;
        const arv = document.getElementById("arv").value;

        if (beds) data.beds = +beds;
        if (baths) data.baths = +baths;
        if (sqft) data.sqft = +sqft;
        if (yearBuilt) data.yearBuilt = +yearBuilt;
        if (arv) data.arv = +arv;
      } else if (analysisMode === "STANDARD") {
        // Standard Mode: Include optional ARV override
        const arvOverride = document.getElementById("arvOverride").value;
        if (arvOverride) data.arv = +arvOverride;
      }
      // DEEP mode: No extra fields needed (full automation)

      showOverlay(true);
      google.script.run
        .withSuccessHandler(()=>{
          showOverlay(false);
          alert("Analysis complete! Check the generated sheets for results.");
        })
        .withFailureHandler((err)=>{showOverlay(false);alert("Error running analysis: " + err);})
        .runAnalysis(data);
    }

    function testAPI(source){
      showOverlay(true);
      const fn={
        bridge:"testBridgeAPI",
        openai:"testOpenAI",
        gemini:"testGemini"
      }[source];
      google.script.run
        .withSuccessHandler(()=>{showOverlay(false);alert(source+" test complete ‚Äî check logs");})
        .withFailureHandler(()=>{showOverlay(false);alert("Error running "+source+" test");})
        [fn]();
    }
  </script>
</body>
</html>
